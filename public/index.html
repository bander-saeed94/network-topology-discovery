<!DOCTYPE html>
<html>
<head>
    <title>Optimized Network Topology Visualization</title>
    <script src="https://unpkg.com/vis-network@9.1.9/dist/vis-network.min.js"></script>
    <link href="https://unpkg.com/vis-network@9.1.9/dist/dist/vis-network.min.css" rel="stylesheet" />
    <style>
        #network {
            width: 100vw;
            height: 100vh;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div id="network"></div>

    <script>
        const nodePositions = new Map();
        let network = null;

        async function fetchDevices() {
            const [deviceRes, ifaceRes] = await Promise.all([
                fetch('/api/discover'),
                fetch('/api/router/interfaces')
            ]);

            let devices = await deviceRes.json();
            const interfaces = await ifaceRes.json();

            let nodes = new Map();
            let edges = new Set();

            const interfaceIPs = new Set(interfaces.map(iface => iface.ip));
            devices = devices.filter(device => !interfaceIPs.has(device.ip));

            nodes.set(0, {
                id: 0,
                label: 'Router',
                shape: 'ellipse',
                color: '#ffcccc',
                font: { size: 18, bold: true }
            });

            const interfaceNodes = new Map();
            interfaces.forEach(iface => {
                if (!interfaceNodes.has(iface.interface)) {
                    const nodeId = nodes.size + 1;
                    interfaceNodes.set(iface.interface, nodeId);
                    nodes.set(nodeId, {
                        id: nodeId,
                        label: `Iface ${iface.interface}\n${iface.ip}`,
                        shape: 'circle',
                        color: '#ccffcc',
                        font: { size: 16, bold: true }
                    });
                    edges.add(JSON.stringify({ from: 0, to: nodeId }));
                }
            });

            const devicesByInterface = new Map();
            devices.forEach(device => {
                if (!devicesByInterface.has(device.interface)) {
                    devicesByInterface.set(device.interface, []);
                }
                devicesByInterface.get(device.interface).push(device);
            });

            devices.forEach(device => {
                if (device.ip !== '172.16.137.20') {
                    const deviceNodeId = nodes.size + 1;
                    nodes.set(deviceNodeId, {
                        id: deviceNodeId,
                        label: `${device.ip}\n${device.mac}`,
                        shape: 'box',
                        font: { size: 14 }
                    });

                    if (interfaceNodes.has(device.interface)) {
                        edges.add(JSON.stringify({
                            from: interfaceNodes.get(device.interface),
                            to: deviceNodeId
                        }));
                    }

                    devicesByInterface.get(device.interface).forEach(peer => {
                        if (peer.ip !== device.ip) {
                            const peerNode = [...nodes.values()].find(n => n.label.includes(peer.ip));
                            if (peerNode) {
                                const edgeData = JSON.stringify({ from: deviceNodeId, to: peerNode.id, dashes: true });
                                if (!edges.has(edgeData)) {
                                    edges.add(edgeData);
                                }
                            }
                        }
                    });
                }
            });

            const visNodes = [...nodes.values()];
            const visEdges = [...edges].map(e => JSON.parse(e));

            // Reuse existing positions
            visNodes.forEach(node => {
                if (nodePositions.has(node.id)) {
                    const pos = nodePositions.get(node.id);
                    node.x = pos.x;
                    node.y = pos.y;
                    node.fixed = { x: true, y: true };
                }
            });

            const container = document.getElementById('network');

            if (!network) {
                network = new vis.Network(container, { nodes: visNodes, edges: visEdges }, {
                    layout: { improvedLayout: true },
                    physics: false
                });

                network.once("stabilized", () => {
                    const positions = network.getPositions();
                    for (const [id, pos] of Object.entries(positions)) {
                        nodePositions.set(Number(id), pos);
                    }
                });
            } else {
                network.setData({ nodes: visNodes, edges: visEdges });
            }
        }

        fetchDevices();
        setInterval(fetchDevices, 10000);
    </script>
</body>
</html>
