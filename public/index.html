<!DOCTYPE html>
<html>
<head>
  <title>Network Topology</title>
  <script src="/lib/vis-network/vis-network.min.js"></script>
  <link href="/lib/vis-network/vis-network.min.css" rel="stylesheet" />
  <style>
    #network {
      width: 100vw;
      height: 100vh;
      border: 1px solid lightgray;
    }
  </style>
</head>
<body>
  <div id="network"></div>
  <script>
    async function loadTopology() {
      const res = await fetch('/api/topology');
      const topology = await res.json();

      const nodes = new Map();
      const edges = new Set();

      // Add routers and their interfaces
      topology.forEach(router => {
        nodes.set(router.routerName, {
          id: router.routerName,
          label: router.routerName,
          group: 'router'
        });

        // Connect to neighbor routers
        router.neighborRouter.forEach(n => {
          const neighborRouter = topology.find(r => r.interfaces.some(i => i.ip === n.ip));
          if (neighborRouter) {
            const neighborName = neighborRouter.routerName;
            const edgeId = [router.routerName, neighborName].sort().join('-');

            if (!edges.has(edgeId)) {
              edges.add(edgeId);
            }
          }
        });

        // Connect to hosts
        router.host.forEach(h => {
          const hostId = h.ip;
          if (!nodes.has(hostId)) {
            nodes.set(hostId, {
              id: hostId,
              label: h.ip,
              group: 'host'
            });
          }
          edges.add(`${router.routerName}->${hostId}`);
        });
      });

      const data = {
        nodes: Array.from(nodes.values()),
        edges: Array.from(edges).map(e => {
          if (e.includes('->')) {
            const [from, to] = e.split('->');
            return { from, to };
          } else {
            const [from, to] = e.split('-');
            return { from, to };
          }
        })
      };

      const container = document.getElementById('network');
      const options = {
        groups: {
          router: { shape: 'box', color: '#ADD8E6' },
          host: { shape: 'ellipse', color: '#FFDD99' }
        },
        layout: {
          hierarchical: {
            enabled: true,
            direction: 'LR',
            sortMethod: 'hubsize'
          }
        },
        physics: false
      };

      new vis.Network(container, data, options);
    }

    loadTopology();
  </script>
</body>
</html>
