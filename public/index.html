<script>
    let network = null;
    const nodePositions = new Map();

    async function fetchTopology() {
        const res = await fetch('/api/topology');
        const topology = await res.json();

        const nodes = new Map();
        const edges = new Set();

        topology.forEach(router => {
            // Add router node
            nodes.set(router.routerName, {
                id: router.routerName,
                label: router.routerName,
                shape: 'box',
                color: '#ADD8E6',
                font: { size: 16, bold: true }
            });

            // Add host nodes and edges
            router.host.forEach(h => {
                nodes.set(h.ip, {
                    id: h.ip,
                    label: h.ip,
                    shape: 'ellipse',
                    color: '#FFDD99'
                });
                edges.add(JSON.stringify({ from: router.routerName, to: h.ip }));
            });

            // Add neighbor routers as edges
            router.neighborRouter.forEach(n => {
                const neighbor = topology.find(r => r.interfaces.some(i => i.ip === n.ip));
                const target = neighbor ? neighbor.routerName : n.ip;
                if (!nodes.has(target)) {
                    nodes.set(target, {
                        id: target,
                        label: target,
                        shape: 'box',
                        color: '#ADD8E6'
                    });
                }
                edges.add(JSON.stringify({ from: router.routerName, to: target }));
            });
        });

        const visNodes = [...nodes.values()];
        const visEdges = [...edges].map(e => JSON.parse(e));

        // Restore positions if previously saved
        visNodes.forEach(node => {
            if (nodePositions.has(node.id)) {
                const pos = nodePositions.get(node.id);
                node.x = pos.x;
                node.y = pos.y;
                node.fixed = { x: true, y: true };
            }
        });

        const container = document.getElementById('network');
        const options = {
            layout: { improvedLayout: true },
            physics: false
        };

        if (!network) {
            network = new vis.Network(container, { nodes: visNodes, edges: visEdges }, options);
            network.once('stabilized', () => {
                const positions = network.getPositions();
                for (const [id, pos] of Object.entries(positions)) {
                    nodePositions.set(id, pos);
                }
            });
        } else {
            network.setData({ nodes: visNodes, edges: visEdges });
        }
    }

    fetchTopology();
    setInterval(fetchTopology, 30000);
</script>
